-- Ultra Farm Pet Swarm Simulator
-- Versão: 3.1 - Otimizado

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "Pet Swarm Ultra Farm",
    LoadingTitle = "Carregando Script...",
    LoadingSubtitle = "Feito por Ln",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "PetSwarmUltraFarm",
        FileName = "Config"
    },
    Discord = {
        Enabled = true,
        Invite = "https://discord.gg/hCAtrZTQR6",
        RememberJoins = true
    },
    KeySystem = true,
    KeySettings = {
        Title = "Pet Swarm Ultra Farm",
        Subtitle = "Insira a chave para continuar",
        Note = "Junte-se ao Discord para obter a chave",
        FileName = "Key",
        SaveKey = true,
        GrabKeyFromSite = false,
        Key = {"dzk"}
    }
})

-- Serviços
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")
local LocalPlayer = Players.LocalPlayer

-- Remotes
local CombatRF = ReplicatedStorage.Remotes.Functions.CombatRF
local CollectionRF = ReplicatedStorage.Remotes.Functions.CollectionRF
local HatchEggEvent = ReplicatedStorage.Remotes.Events.HatchEggEvent
local PlantEggEvent = ReplicatedStorage.Remotes.Events.PlantEggEvent
local ZonesRF = ReplicatedStorage.Remotes.Functions.ZonesRF

-- Variáveis globais
local ultraFarmActive = false
local ultraFarmThreads = {}
local runningLoops = {}

-- Lista completa de eggs para plantar
local eggsList = {
    ["Void Egg"] = "27",
    ["Winter Event"] = "WinterEvent1",
    ["Egg Event"] = "EleEgg1",
    ["Tower Draco"] = "34",
    ["Zone 12.1"] = "12.1",
    ["Tiki Egg"] = "30",
    ["Summer Egg"] = "SummerEvent1"
}

-- Lista completa de bosses
local allBosses = {
    {name = "Great Sphinx", zone = "ElementEventZoneB1"},
    {name = "Tiki Monster", zone = "Zone10B1"},
    {name = "The Frozen Ancient", zone = "Zone12B1"},
    {name = "The Big 100M", zone = "Zone12B3"},
    {name = "The Ethereal Everia", zone = "Zone12B2"},
    {name = "The Ice Serpent", zone = "WinterEventZoneB1"},
    {name = "Hornet Boss", zone = "SummerEventZoneB1"},
    {name = "Ghost Pirate", isNil = true},
    {name = "Naga", zone = "Zone2B1"},
    {name = "Lava Monster", zone = "Zone5B1"}
}

-- Configurações
local selectedEggs = {"Winter Event"}
local selectedBosses = {"Great Sphinx", "Tiki Monster", "The Frozen Ancient", "The Big 100M", "The Ethereal Everia", "The Ice Serpent", "Hornet Boss"}
local speedSettings = {
    eggFarm = 1.5,
    bossFarm = 0.5,
    foodFarm = 1,
    antiAFKInterval = 30,
    autoHashCount = 15,
    autoHashDelay = 0.01,
    delayBetweenBosses = 0.3
}

-- Configurações de extras
local extrasSettings = {
    autoClickEnabled = false,
    speedEnabled = false,
    autoClickCPS = 50
}

-- Cache para zones
local zoneCache = {}
local function getZone(zoneName)
    if not zoneCache[zoneName] then
        zoneCache[zoneName] = Workspace.Zones:FindFirstChild(zoneName)
    end
    return zoneCache[zoneName]
end

-- Função para criar loops controlados
local function createLoop(name, func, interval)
    if runningLoops[name] then
        runningLoops[name] = false
        task.wait(0.1)
    end
    
    runningLoops[name] = true
    
    task.spawn(function()
        while runningLoops[name] do
            local success, err = pcall(func)
            if not success then
                warn("Erro no loop " .. name .. ": " .. err)
            end
            task.wait(interval or 0.1)
        end
    end)
end

-- Função para obter todos os pets
local function getPets()
    local pets = {}
    if LocalPlayer and LocalPlayer.Character then
        local petFolder = LocalPlayer.Character:FindFirstChild("Pets")
        if petFolder then
            for _, pet in pairs(petFolder:GetChildren()) do
                table.insert(pets, pet)
            end
        end
    end
    return pets
end

-- Sistema Auto-Hash
local autoHashRunning = false
local function executeAutoHash()
    if autoHashRunning then return end
    autoHashRunning = true
    
    for i = 1, speedSettings.autoHashCount do
        task.spawn(function()
            pcall(function()
                HatchEggEvent:FireServer()
            end)
        end)
        task.wait(speedSettings.autoHashDelay)
    end
    
    autoHashRunning = false
end

-- Função para obter boss nil
local function getNilBoss(bossName)
    for _, v in pairs(getnilinstances()) do
        if v.ClassName == "Vector3Value" and v.Name == bossName then
            return v
        end
    end
    return nil
end

-- Função para verificar se boss está vivo
local function isBossAlive(bossInfo)
    if bossInfo.isNil then
        return getNilBoss(bossInfo.name) ~= nil
    end
    
    local zone = getZone(bossInfo.zone)
    if not zone then return false end
    
    local enemies = zone:FindFirstChild("Enemies")
    if not enemies then return false end
    
    return enemies:FindFirstChild(bossInfo.name) ~= nil
end

-- Função para atacar boss específico
local function attackBoss(bossInfo)
    local bossInstance = nil
    
    if bossInfo.isNil then
        bossInstance = getNilBoss(bossInfo.name)
    else
        local zone = getZone(bossInfo.zone)
        if zone then
            local enemies = zone:FindFirstChild("Enemies")
            if enemies then
                bossInstance = enemies:FindFirstChild(bossInfo.name)
            end
        end
    end
    
    if bossInstance then
        local pets = getPets()
        for _, pet in pairs(pets) do
            task.spawn(function()
                pcall(function()
                    CombatRF:InvokeServer("AttackEnemy", bossInstance, pet)
                end)
            end)
        end
        return true
    end
    
    return false
end

-- FUNÇÃO PARA FARMAR BOSSES SELECIONADOS
local function farmSelectedBosses()
    for _, bossInfo in pairs(allBosses) do
        local isSelected = table.find(selectedBosses, bossInfo.name)
        
        if isSelected and isBossAlive(bossInfo) then
            attackBoss(bossInfo)
            task.wait(speedSettings.delayBetweenBosses)
        end
    end
end

-- FUNÇÃO PARA FARMAR SUMMER EVENT ENEMIES
local function farmSummerEventEnemies()
    local zone = getZone("SummerEventZone")
    if not zone then return end
    
    local enemies = zone:FindFirstChild("Enemies")
    if not enemies then return end
    
    local summerEventEnemies = enemies:FindFirstChild("SummerEventEnemy")
    if not summerEventEnemies then return end
    
    local pets = getPets()
    
    for _, enemy in pairs(summerEventEnemies:GetChildren()) do
        for _, pet in pairs(pets) do
            task.spawn(function()
                pcall(function()
                    CombatRF:InvokeServer("AttackEnemy", enemy, pet)
                end)
            end)
        end
    end
end

-- Função para coletar comida
local function collectFood()
    local zone = getZone("Zone12")
    if not zone then return end
    
    local foodSpawns = zone:FindFirstChild("FoodSpawns")
    if not foodSpawns then return end
    
    local pets = getPets()
    
    for _, food in pairs(foodSpawns:GetChildren()) do
        for _, pet in pairs(pets) do
            task.spawn(function()
                pcall(function()
                    CollectionRF:InvokeServer("CollectFood", food, pet)
                end)
            end)
        end
    end
end

-- Função para farmar eggs
local function farmEggs()
    -- Auto-hash
    executeAutoHash()
    
    -- Plantar eggs selecionados
    for _, eggName in pairs(selectedEggs) do
        local eggArg = eggsList[eggName]
        if eggArg then
            for i = 1, 3 do  -- Reduzido para 3 para melhor performance
                task.spawn(function()
                    pcall(function()
                        PlantEggEvent:FireServer(eggArg)
                    end)
                end)
                task.wait(0.01)
            end
        end
    end
end

-- Sistema Anti-AFK
local function performAntiAFK()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Space, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Space, false, game)
    end
end

-- Sistema de velocidade
local speedConnection
local function applySpeedBoost()
    if not LocalPlayer.Character then return end
    
    local humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    humanoid.WalkSpeed = 50
    
    if speedConnection then
        speedConnection:Disconnect()
    end
    
    speedConnection = humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
        if humanoid.WalkSpeed < 50 then
            humanoid.WalkSpeed = 50
        end
    end)
end

local function removeSpeedBoost()
    if speedConnection then
        speedConnection:Disconnect()
        speedConnection = nil
    end
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = 16
    end
end

-- Função para parar Ultra Farm
local function stopUltraFarm()
    ultraFarmActive = false
    
    for i = #ultraFarmThreads, 1, -1 do
        local thread = ultraFarmThreads[i]
        if thread then
            task.cancel(thread)
        end
        table.remove(ultraFarmThreads, i)
    end
    
    if extrasSettings.speedEnabled then
        removeSpeedBoost()
    end
end

-- Função para iniciar o Ultra Farm
local function startUltraFarm()
    if ultraFarmActive then return end
    ultraFarmActive = true
    
    -- Aplicar velocidade se ativado
    if extrasSettings.speedEnabled then
        applySpeedBoost()
    end
    
    -- Farm de eggs
    table.insert(ultraFarmThreads, task.spawn(function()
        while ultraFarmActive do
            farmEggs()
            task.wait(speedSettings.eggFarm)
        end
    end))
    
    -- Farm de bosses
    table.insert(ultraFarmThreads, task.spawn(function()
        while ultraFarmActive do
            farmSelectedBosses()
            farmSummerEventEnemies()
            task.wait(speedSettings.bossFarm)
        end
    end))
    
    -- Farm de comida
    table.insert(ultraFarmThreads, task.spawn(function()
        while ultraFarmActive do
            collectFood()
            task.wait(speedSettings.foodFarm)
        end
    end))
    
    -- Anti-AFK
    table.insert(ultraFarmThreads, task.spawn(function()
        while ultraFarmActive do
            task.wait(speedSettings.antiAFKInterval)
            performAntiAFK()
        end
    end))
    
    Rayfield:Notify({
        Title = "Ultra Farm Iniciado",
        Content = "Farming ativo com " .. #selectedEggs .. " eggs e " .. #selectedBosses .. " bosses",
        Duration = 3,
        Image = 4483362458,
    })
end

-- Função para parar todos os loops
local function stopAllLoops()
    stopUltraFarm()
    
    for loopName in pairs(runningLoops) do
        runningLoops[loopName] = false
    end
    runningLoops = {}
    
    Rayfield:Notify({
        Title = "Tudo Parado",
        Content = "Todos os loops foram interrompidos.",
        Duration = 3,
        Image = 4483362458,
    })
end

-- Criar abas
local UltraFarmTab = Window:CreateTab("Ultra Farm", 4483362458)
local ExtrasTab = Window:CreateTab("Extras", 4483362458)
local SettingsTab = Window:CreateTab("Configurações", 4483362458)

-- ============================
-- ULTRA FARM TAB
-- ============================
UltraFarmTab:CreateSection("Controles Principais")

UltraFarmTab:CreateButton({
    Name = "Iniciar Ultra Farm",
    Callback = function()
        startUltraFarm()
    end,
})

UltraFarmTab:CreateButton({
    Name = "Parar Ultra Farm",
    Callback = function()
        stopUltraFarm()
    end,
})

UltraFarmTab:CreateButton({
    Name = "Parar Tudo",
    Callback = function()
        stopAllLoops()
    end,
})

UltraFarmTab:CreateSection("Seleção de Eggs")
for eggName, _ in pairs(eggsList) do
    UltraFarmTab:CreateToggle({
        Name = eggName,
        CurrentValue = eggName == "Winter Event",
        Flag = "EggToggle_" .. eggName,
        Callback = function(Value)
            if Value then
                if not table.find(selectedEggs, eggName) then
                    table.insert(selectedEggs, eggName)
                end
            else
                local index = table.find(selectedEggs, eggName)
                if index then
                    table.remove(selectedEggs, index)
                end
            end
        end,
    })
end

UltraFarmTab:CreateSection("Seleção de Bosses")
for _, bossInfo in pairs(allBosses) do
    UltraFarmTab:CreateToggle({
        Name = bossInfo.name,
        CurrentValue = table.find(selectedBosses, bossInfo.name) ~= nil,
        Flag = "BossToggle_" .. bossInfo.name,
        Callback = function(Value)
            if Value then
                if not table.find(selectedBosses, bossInfo.name) then
                    table.insert(selectedBosses, bossInfo.name)
                end
            else
                local index = table.find(selectedBosses, bossInfo.name)
                if index then
                    table.remove(selectedBosses, index)
                end
            end
        end,
    })
end

-- ============================
-- EXTRAS TAB
-- ============================
ExtrasTab:CreateSection("Auto Clicker")

local autoClickLoop
ExtrasTab:CreateToggle({
    Name = "Auto Clicker",
    CurrentValue = false,
    Flag = "AutoClickerToggle",
    Callback = function(Value)
        extrasSettings.autoClickEnabled = Value
        
        if Value then
            autoClickLoop = task.spawn(function()
                while extrasSettings.autoClickEnabled do
                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
                    task.wait()
                    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
                    task.wait(1/extrasSettings.autoClickCPS)
                end
            end)
        elseif autoClickLoop then
            task.cancel(autoClickLoop)
        end
    end,
})

ExtrasTab:CreateSlider({
    Name = "CPS (Clicks por Segundo)",
    Range = {1, 100},
    Increment = 1,
    Suffix = " CPS",
    CurrentValue = 50,
    Flag = "CPSValue",
    Callback = function(Value)
        extrasSettings.autoClickCPS = Value
    end,
})

ExtrasTab:CreateSection("Velocidade")

ExtrasTab:CreateToggle({
    Name = "Velocidade 3x",
    CurrentValue = false,
    Flag = "SpeedToggle",
    Callback = function(Value)
        extrasSettings.speedEnabled = Value
        
        if Value then
            applySpeedBoost()
        else
            removeSpeedBoost()
        end
    end,
})

-- ============================
-- CONFIGURAÇÕES TAB
-- ============================
SettingsTab:CreateSection("Timers")

SettingsTab:CreateSlider({
    Name = "Timer Eggs",
    Range = {0.1, 5},
    Increment = 0.1,
    Suffix = "s",
    CurrentValue = speedSettings.eggFarm,
    Flag = "EggTimer",
    Callback = function(Value)
        speedSettings.eggFarm = Value
    end,
})

SettingsTab:CreateSlider({
    Name = "Timer Bosses",
    Range = {0.1, 3},
    Increment = 0.1,
    Suffix = "s",
    CurrentValue = speedSettings.bossFarm,
    Flag = "BossTimer",
    Callback = function(Value)
        speedSettings.bossFarm = Value
    end,
})

SettingsTab:CreateSlider({
    Name = "Timer Comida",
    Range = {0.1, 5},
    Increment = 0.1,
    Suffix = "s",
    CurrentValue = speedSettings.foodFarm,
    Flag = "FoodTimer",
    Callback = function(Value)
        speedSettings.foodFarm = Value
    end,
})

SettingsTab:CreateSlider({
    Name = "Delay entre Bosses",
    Range = {0.1, 1},
    Increment = 0.1,
    Suffix = "s",
    CurrentValue = speedSettings.delayBetweenBosses,
    Flag = "BossDelay",
    Callback = function(Value)
        speedSettings.delayBetweenBosses = Value
    end,
})

SettingsTab:CreateSection("Auto Hash")

SettingsTab:CreateSlider({
    Name = "Quantidade de Hash",
    Range = {1, 30},
    Increment = 1,
    Suffix = "x",
    CurrentValue = speedSettings.autoHashCount,
    Flag = "AutoHashCount",
    Callback = function(Value)
        speedSettings.autoHashCount = Value
    end,
})

SettingsTab:CreateSlider({
    Name = "Delay Hash",
    Range = {0.01, 0.1},
    Increment = 0.01,
    Suffix = "s",
    CurrentValue = speedSettings.autoHashDelay,
    Flag = "AutoHashDelay",
    Callback = function(Value)
        speedSettings.autoHashDelay = Value
    end,
})

SettingsTab:CreateSection("Anti-AFK")

SettingsTab:CreateSlider({
    Name = "Intervalo Anti-AFK",
    Range = {10, 60},
    Increment = 5,
    Suffix = "s",
    CurrentValue = speedSettings.antiAFKInterval,
    Flag = "AntiAFKInterval",
    Callback = function(Value)
        speedSettings.antiAFKInterval = Value
    end,
})

SettingsTab:CreateSection("Interface")

SettingsTab:CreateButton({
    Name = "Salvar Configurações",
    Callback = function()
        Rayfield:Notify({
            Title = "Configurações Salvas",
            Content = "Suas configurações foram salvas com sucesso!",
            Duration = 3,
            Image = 4483362458,
        })
    end,
})

SettingsTab:CreateButton({
    Name = "Redefinir Tudo",
    Callback = function()
        stopAllLoops()
        selectedEggs = {"Winter Event"}
        selectedBosses = {"Great Sphinx", "Tiki Monster", "The Frozen Ancient", "The Big 100M", "The Ethereal Everia", "The Ice Serpent", "Hornet Boss"}
        
        for eggName, toggle in pairs(eggToggles or {}) do
            if toggle then
                toggle:Set(eggName == "Winter Event")
            end
        end
        
        Rayfield:Notify({
            Title = "Reiniciado",
            Content = "Todas as configurações foram redefinidas.",
            Duration = 3,
            Image = 4483362458,
        })
    end,
})

-- Inicialização
Rayfield:Notify({
    Title = "Pet Swarm Ultra Farm Carregado",
    Content = "Versão 3.1 - Pronto para usar!",
    Duration = 5,
    Image = 4483362458,
})
